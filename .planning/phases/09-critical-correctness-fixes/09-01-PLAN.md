---
phase: 09-critical-correctness-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/managers/transcription.rs
  - src-tauri/src/ghostwriter.rs
autonomous: true

must_haves:
  truths:
    - "Model unloading respects configured timeout (not unloading early)"
    - "Ghostwriter tests correctly validate missing API key error handling"
    - "Unit tests pass without assertion failures"
  artifacts:
    - path: "src-tauri/src/managers/transcription.rs"
      provides: "Consistent millisecond timestamps in last_activity"
      pattern: "as_millis\\(\\) as u64"
      min_occurrences: 3
    - path: "src-tauri/src/ghostwriter.rs"
      provides: "Correct test assertions for error cases"
      pattern: "assert!\\(result\\.is_err\\(\\)\\)"
      min_occurrences: 2
  key_links:
    - from: "TranscriptionManager::load_model"
      to: "last_activity atomic"
      via: "store() with millis"
      pattern: "last_activity\\.store.*as_millis"
    - from: "idle watcher thread"
      to: "last_activity atomic"
      via: "load() and compare with now_ms"
      pattern: "last_activity\\.load.*now_ms"
---

<objective>
Fix critical timing bug causing premature model unloading and broken ghostwriter unit tests.

Purpose: Ensure model unload timeout works correctly and tests validate actual error behavior
Output: Consistent millisecond-based timestamps, passing unit tests with correct assertions
</objective>

<execution_context>
@C:/Users/hsbaz/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hsbaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src-tauri/src/managers/transcription.rs
@src-tauri/src/ghostwriter.rs
</context>

<tasks>

<task type="auto">
  <name>Fix last_activity unit mismatch in TranscriptionManager</name>
  <files>src-tauri/src/managers/transcription.rs</files>
  <action>
Fix CRITICAL timing bug where `last_activity` uses inconsistent time units:

**Current state:**
- Initialized with `as_millis()` at line 62
- Updated with `as_secs()` at line 297 in `load_model()` (BUG)
- Compared with `as_millis()` at line 352 in `transcribe()` and line 98 in idle watcher

**Fix:**
Change line 297 from:
```rust
.as_secs(),
```
to:
```rust
.as_millis() as u64,
```

**Why:** The idle watcher compares `now_ms.saturating_sub(last) > limit_seconds * 1000` expecting milliseconds. When `load_model` stores seconds, the comparison treats seconds as milliseconds, causing models to unload ~1000x earlier than configured (e.g., 2-minute timeout becomes ~120 milliseconds).

**Verification approach:** After fix, all three update sites (line 62 init, line 297 load_model, line 352 transcribe) will use `as_millis() as u64`, and comparison at line 100 correctly multiplies `limit_seconds * 1000`.
  </action>
  <verify>
```bash
# Verify all timestamp operations use milliseconds
grep -n "last_activity" src-tauri/src/managers/transcription.rs | grep -E "(as_millis|as_secs)"

# Build to ensure no compilation errors
cd src-tauri && cargo build
```

Expected: All `last_activity` stores use `as_millis() as u64`, no `as_secs()` calls for this field.
  </verify>
  <done>
- Line 297 changed from `as_secs()` to `as_millis() as u64`
- Code compiles without errors
- All `last_activity` operations use consistent millisecond units
  </done>
</task>

<task type="auto">
  <name>Fix ghostwriter test assertions for error cases</name>
  <files>src-tauri/src/ghostwriter.rs</files>
  <action>
Fix broken unit tests that assert `is_ok()` when `process_text()` actually returns `Err` for missing/empty API keys.

**Current behavior (line 52-55):**
```rust
if api_key.is_none() || api_key.as_ref().is_some_and(|k| k.trim().is_empty()) {
    return Err("OpenRouter API key is required".to_string());
}
```

**Broken tests (lines 496-522):**
- `test_no_api_key_returns_original`: Asserts `result.is_ok()` but function returns `Err`
- `test_empty_api_key_returns_original`: Asserts `result.is_ok()` but function returns `Err`

**Fix both tests:**

Replace lines 506-507:
```rust
assert!(result.is_ok());
assert_eq!(result.unwrap(), "test text");
```
with:
```rust
assert!(result.is_err());
assert_eq!(result.unwrap_err(), "OpenRouter API key is required");
```

Replace lines 520-521:
```rust
assert!(result.is_ok());
assert_eq!(result.unwrap(), "test text");
```
with:
```rust
assert!(result.is_err());
assert_eq!(result.unwrap_err(), "OpenRouter API key is required");
```

**Why:** Tests document the contract â€” `process_text` MUST error on missing/empty API keys (security best practice). Tests were written expecting old behavior but never updated when error handling was added.
  </action>
  <verify>
```bash
# Run ghostwriter tests to confirm they pass
cd src-tauri && cargo test ghostwriter -- --nocapture
```

Expected: All tests in `ghostwriter::tests` module pass, specifically `test_no_api_key_returns_original` and `test_empty_api_key_returns_original`.
  </verify>
  <done>
- Both test functions assert `is_err()` instead of `is_ok()`
- Both test functions verify error message equals "OpenRouter API key is required"
- `cargo test ghostwriter` passes without failures
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:

```bash
cd src-tauri && cargo test
```

Test model unload timing manually (if debug mode available):
1. Enable debug mode (Ctrl+Shift+D on Windows)
2. Set model unload timeout to 5 seconds (debug-only option)
3. Load a model and wait 5 seconds
4. Verify model unloads after ~5 seconds (not immediately)
</verification>

<success_criteria>
- All changes to `last_activity` use `as_millis() as u64` consistently
- No `as_secs()` calls remain for `last_activity` field
- Both ghostwriter tests assert `is_err()` and verify error message
- `cargo test` passes with 0 failures
- Code compiles without warnings in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/09-critical-correctness-fixes/09-01-SUMMARY.md`
</output>
