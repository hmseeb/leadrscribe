---
phase: 09-critical-correctness-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/commands/models.rs
autonomous: true

must_haves:
  truths:
    - "Onboarding shows accurate status when model downloads are in progress"
    - "Model loading status reflects actual loading state (not inverted)"
    - "UI can distinguish between 'no model loaded' and 'model currently loading'"
  artifacts:
    - path: "src-tauri/src/commands/models.rs"
      provides: "Download detection in has_any_models_or_downloads"
      pattern: "m\\.is_downloading"
      min_occurrences: 1
    - path: "src-tauri/src/commands/models.rs"
      provides: "Accurate loading state from TranscriptionManager"
      contains: "is_loading()"
  key_links:
    - from: "has_any_models_or_downloads command"
      to: "model_manager.get_available_models()"
      via: "iter().any() checking is_downloaded OR is_downloading"
      pattern: "m\\.is_downloaded.*m\\.is_downloading"
    - from: "is_model_loading command"
      to: "transcription_manager.is_loading()"
      via: "return actual loading state"
      pattern: "transcription_manager.*is_loading"
---

<objective>
Fix model download detection and loading status reporting for accurate UI feedback.

Purpose: Ensure onboarding doesn't show "no models" during downloads and UI gets correct loading state
Output: Accurate download progress detection and model loading status commands
</objective>

<execution_context>
@C:/Users/hsbaz/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hsbaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src-tauri/src/commands/models.rs
@src-tauri/src/managers/transcription.rs
</context>

<tasks>

<task type="auto">
  <name>Fix has_any_models_or_downloads to detect active downloads</name>
  <files>src-tauri/src/commands/models.rs</files>
  <action>
Fix `has_any_models_or_downloads` command that ignores active downloads, causing onboarding to incorrectly show "no models available" while downloads are in progress.

**Current implementation (lines 110-117):**
```rust
#[tauri::command]
pub async fn has_any_models_or_downloads(
    model_manager: State<'_, Arc<ModelManager>>,
) -> Result<bool, String> {
    let models = model_manager.get_available_models();
    // Return true if any models are downloaded OR if any downloads are in progress
    Ok(models.iter().any(|m| m.is_downloaded))  // BUG: comment says OR but only checks is_downloaded
}
```

**Fix line 116:**
Change from:
```rust
Ok(models.iter().any(|m| m.is_downloaded))
```
to:
```rust
Ok(models.iter().any(|m| m.is_downloaded || m.is_downloading))
```

**Why:** The comment explicitly states the intent ("OR if any downloads are in progress") but implementation only checks `is_downloaded`. This causes onboarding to show "No models available" while model downloads are actively running, confusing users.

**Context:** ModelInfo struct (from ModelManager) has both `is_downloaded: bool` and `is_downloading: bool` fields. Command should check both.
  </action>
  <verify>
```bash
# Verify the fix is applied correctly
grep -A 3 "has_any_models_or_downloads" src-tauri/src/commands/models.rs | grep "is_downloading"

# Build to ensure no compilation errors
cd src-tauri && cargo build
```

Expected: Line 116 includes `|| m.is_downloading` check.
  </verify>
  <done>
- Line 116 changed to `Ok(models.iter().any(|m| m.is_downloaded || m.is_downloading))`
- Code compiles without errors
- Function matches its documented behavior (comment is now accurate)
  </done>
</task>

<task type="auto">
  <name>Fix is_model_loading to return actual loading state</name>
  <files>src-tauri/src/commands/models.rs</files>
  <action>
Fix `is_model_loading` command that returns inverted semantics — currently returns "is no model loaded" instead of "is model currently loading".

**Current implementation (lines 93-100):**
```rust
#[tauri::command]
pub async fn is_model_loading(
    transcription_manager: State<'_, Arc<TranscriptionManager>>,
) -> Result<bool, String> {
    // Check if transcription manager has a loaded model
    let current_model = transcription_manager.get_current_model();
    Ok(current_model.is_none())  // BUG: returns "no model" not "is loading"
}
```

**Problem:** Function name suggests checking loading state, but implementation just returns whether model is absent. This doesn't distinguish between:
- No model loaded (idle)
- Model currently loading (in progress)

**First, check if TranscriptionManager exposes loading state:**
Look for `is_loading()` or `is_loading` field in `src-tauri/src/managers/transcription.rs` (visible in line 66: `is_loading: Arc<Mutex<bool>>`).

**Fix approach:**
Replace lines 97-99 with:
```rust
// Check if a model is currently being loaded
let is_loading = transcription_manager.is_loading();
Ok(is_loading)
```

**If `is_loading()` method doesn't exist:** Add it to TranscriptionManager:
```rust
pub fn is_loading(&self) -> bool {
    *self.is_loading.lock().unwrap()
}
```

**Why:** UI needs to know when model loading is in progress (to show spinners, disable buttons, etc.). Current implementation can't distinguish "idle with no model" from "actively loading model".
  </action>
  <verify>
```bash
# Check if is_loading method exists in TranscriptionManager
grep -n "pub fn is_loading" src-tauri/src/managers/transcription.rs

# Verify the command fix
grep -A 5 "pub async fn is_model_loading" src-tauri/src/commands/models.rs

# Build to ensure no compilation errors
cd src-tauri && cargo build
```

Expected: `is_model_loading` command calls `transcription_manager.is_loading()` and returns actual loading state.
  </verify>
  <done>
- `is_model_loading` command returns actual loading state from `transcription_manager.is_loading()`
- If needed, `is_loading()` method added to TranscriptionManager exposing `self.is_loading` field
- Code compiles without errors
- Function semantics match its name (returns true when loading, false otherwise)
  </done>
</task>

</tasks>

<verification>
Functional verification (if possible without full onboarding flow):

```bash
# Build and test compilation
cd src-tauri && cargo build

# If unit tests exist for these commands
cd src-tauri && cargo test commands::models
```

Manual verification approach:
1. Start app with no models downloaded
2. Trigger model download
3. Call `has_any_models_or_downloads` → should return `true` during download
4. Call `is_model_loading` during model load → should return `true`
5. After loading completes → `is_model_loading` should return `false`
</verification>

<success_criteria>
- `has_any_models_or_downloads` checks both `is_downloaded` and `is_downloading`
- `is_model_loading` returns actual loading state from `transcription_manager.is_loading()`
- Code compiles without errors or warnings
- Both commands have semantics matching their names and documentation
</success_criteria>

<output>
After completion, create `.planning/phases/09-critical-correctness-fixes/09-02-SUMMARY.md`
</output>
