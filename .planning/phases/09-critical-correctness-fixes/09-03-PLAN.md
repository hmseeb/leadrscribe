---
phase: 09-critical-correctness-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types.ts
  - src/components/settings/ShowOverlay.tsx
  - src-tauri/src/shortcut.rs
autonomous: true

must_haves:
  truths:
    - "FollowCursor appears as selectable option in overlay position dropdown"
    - "Selecting FollowCursor updates settings and overlay behavior"
    - "TypeScript types include follow_cursor variant"
  artifacts:
    - path: "src/lib/types.ts"
      provides: "OverlayPosition type with follow_cursor"
      pattern: 'z\\.enum\\(\\[.*"follow_cursor".*\\]\\)'
      min_occurrences: 1
    - path: "src/components/settings/ShowOverlay.tsx"
      provides: "FollowCursor option in UI dropdown"
      pattern: 'value: "follow_cursor"'
      min_occurrences: 1
    - path: "src-tauri/src/shortcut.rs"
      provides: "FollowCursor match arm in command handler"
      pattern: '"follow_cursor" => OverlayPosition::FollowCursor'
      min_occurrences: 1
  key_links:
    - from: "ShowOverlay.tsx dropdown"
      to: "updateSetting('overlay_position', value)"
      via: "overlayOptions array with follow_cursor"
      pattern: 'value: "follow_cursor".*OverlayPosition'
    - from: "change_overlay_position_setting command"
      to: "OverlayPosition::FollowCursor"
      via: "string match arm"
      pattern: '"follow_cursor" => OverlayPosition::FollowCursor'
---

<objective>
Add FollowCursor overlay position to TypeScript types, settings UI, and command handler.

Purpose: Make existing FollowCursor backend functionality accessible from settings interface
Output: Complete FollowCursor option in UI with proper type safety and command handling
</objective>

<execution_context>
@C:/Users/hsbaz/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hsbaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/types.ts
@src/components/settings/ShowOverlay.tsx
@src-tauri/src/shortcut.rs
@src-tauri/src/settings.rs
@src-tauri/src/overlay.rs
</context>

<tasks>

<task type="auto">
  <name>Add follow_cursor to TypeScript OverlayPosition type</name>
  <files>src/lib/types.ts</files>
  <action>
Add missing `"follow_cursor"` variant to TypeScript type definition to match Rust enum.

**Current state (line 22):**
```typescript
export const OverlayPositionSchema = z.enum(["none", "top", "bottom"]);
```

**Rust enum (src-tauri/src/settings.rs lines 18-23):**
```rust
pub enum OverlayPosition {
    None,
    Top,
    Bottom,
    FollowCursor,  // Missing in TypeScript
}
```

**Fix line 22:**
Change from:
```typescript
export const OverlayPositionSchema = z.enum(["none", "top", "bottom"]);
```
to:
```typescript
export const OverlayPositionSchema = z.enum(["none", "top", "bottom", "follow_cursor"]);
```

**Why:** TypeScript type must match Rust enum variants (converted to snake_case via `#[serde(rename_all = "lowercase")]`). Without this, selecting FollowCursor from UI would fail type validation.

**Note:** Rust serializes `FollowCursor` → `"followcursor"` due to lowercase serde attribute, but the match arm in shortcut.rs uses `"follow_cursor"` with underscore. Verify which convention is used in settings JSON.
  </action>
  <verify>
```bash
# Check TypeScript type includes follow_cursor
grep "OverlayPositionSchema" src/lib/types.ts

# Verify settings file to see actual serialized format
cat ~/.tauri/leadrscribe/settings.json 2>/dev/null | grep -i overlay || echo "No settings file found (expected on fresh install)"
```

Expected: Line 22 includes `"follow_cursor"` in enum array.
  </verify>
  <done>
- `OverlayPositionSchema` includes all four variants: none, top, bottom, follow_cursor
- TypeScript type `OverlayPosition` automatically infers from schema
- Type definition matches Rust enum structure
  </done>
</task>

<task type="auto">
  <name>Add FollowCursor option to settings UI dropdown</name>
  <files>src/components/settings/ShowOverlay.tsx</files>
  <action>
Add "Follow Cursor" option to overlay position dropdown in settings UI.

**Current overlayOptions array (lines 12-16):**
```typescript
const overlayOptions = [
  { value: "none", label: "None" },
  { value: "bottom", label: "Bottom" },
  { value: "top", label: "Top" },
];
```

**Fix:** Add FollowCursor option:
```typescript
const overlayOptions = [
  { value: "none", label: "None" },
  { value: "bottom", label: "Bottom" },
  { value: "top", label: "Top" },
  { value: "follow_cursor", label: "Follow Cursor" },
];
```

**Why:** Backend supports FollowCursor positioning (implemented in overlay.rs lines 80-82), but UI doesn't expose it. This creates a feature gap where users can't access existing functionality.

**UX consideration:** "Follow Cursor" option will position overlay near mouse cursor when recording starts, useful for users who want overlay near their focus point.
  </action>
  <verify>
```bash
# Verify the option is added
grep -A 5 "overlayOptions" src/components/settings/ShowOverlay.tsx

# Build frontend to check TypeScript compilation
cd . && bun run build
```

Expected: overlayOptions array includes follow_cursor with label "Follow Cursor".
  </verify>
  <done>
- `overlayOptions` array includes `{ value: "follow_cursor", label: "Follow Cursor" }`
- Frontend builds without TypeScript errors
- Dropdown will render "Follow Cursor" as selectable option
  </done>
</task>

<task type="auto">
  <name>Add follow_cursor match arm to command handler</name>
  <files>src-tauri/src/shortcut.rs</files>
  <action>
Add missing `"follow_cursor"` match arm in `change_overlay_position_setting` command handler.

**Current implementation (lines 203-213):**
```rust
#[tauri::command]
pub fn change_overlay_position_setting(app: AppHandle, position: String) -> Result<(), String> {
    let mut settings = settings::get_settings(&app);
    let parsed = match position.as_str() {
        "none" => OverlayPosition::None,
        "top" => OverlayPosition::Top,
        "bottom" => OverlayPosition::Bottom,
        other => {
            eprintln!("Invalid overlay position '{}', defaulting to bottom", other);
            OverlayPosition::Bottom
        }
    };
    // ...
}
```

**Fix:** Add match arm for `"follow_cursor"` (before the `other` catch-all):
```rust
let parsed = match position.as_str() {
    "none" => OverlayPosition::None,
    "top" => OverlayPosition::Top,
    "bottom" => OverlayPosition::Bottom,
    "follow_cursor" => OverlayPosition::FollowCursor,
    other => {
        eprintln!("Invalid overlay position '{}', defaulting to bottom", other);
        OverlayPosition::Bottom
    }
};
```

**Why:** Without this match arm, selecting "Follow Cursor" from UI will fall through to the `other` case, logging an error and defaulting to Bottom instead of applying the user's choice.

**Note:** The Rust enum uses `FollowCursor` (PascalCase) but serde serializes to `"followcursor"` (lowercase) due to `#[serde(rename_all = "lowercase")]` on the enum. However, the command receives the string from TypeScript which uses `"follow_cursor"` (snake_case). Need to verify which format is actually sent.

**Investigation needed:** Check if TypeScript sends `"follow_cursor"` or `"followcursor"`. If serde lowercase applies to both serialization and deserialization, might need `"followcursor"` in match.
  </action>
  <verify>
```bash
# Verify match arm added
grep -A 8 "change_overlay_position_setting" src-tauri/src/shortcut.rs | grep -i cursor

# Build Rust to check compilation
cd src-tauri && cargo build

# Test command handling (if possible)
cd src-tauri && cargo test change_overlay_position || echo "No tests found for this command"
```

Expected: Match statement includes case for follow_cursor string mapping to OverlayPosition::FollowCursor.
  </verify>
  <done>
- Match statement includes `"follow_cursor" => OverlayPosition::FollowCursor` arm
- Code compiles without errors
- Command correctly handles follow_cursor string from TypeScript
- Full flow: UI selection → command → settings update → overlay behavior
  </done>
</task>

</tasks>

<verification>
End-to-end functional verification:

```bash
# Build both frontend and backend
bun run build
cd src-tauri && cargo build
```

Manual testing flow:
1. Start app: `bun run tauri dev`
2. Open settings
3. Find "Overlay Position" dropdown
4. Verify "Follow Cursor" appears as option
5. Select "Follow Cursor"
6. Verify no console errors in frontend or backend logs
7. Trigger recording (press hotkey)
8. Verify overlay appears near cursor position
9. Check settings file to confirm value persisted correctly:
   ```bash
   cat ~/.tauri/leadrscribe/settings.json | grep overlay_position
   ```
</verification>

<success_criteria>
- TypeScript `OverlayPositionSchema` includes `"follow_cursor"`
- UI dropdown shows "Follow Cursor" as selectable option
- Command handler has match arm for `"follow_cursor"` string
- Frontend and backend both compile without errors
- Full selection flow works: UI → command → settings → overlay behavior
</success_criteria>

<output>
After completion, create `.planning/phases/09-critical-correctness-fixes/09-03-SUMMARY.md`
</output>
