---
phase: 11-fix-all-audit-findings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/shortcut.rs
  - src-tauri/src/settings.rs
  - src/stores/settingsStore.ts
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "API key is NOT stored in plaintext settings file when keyring works"
    - "theme_mode field survives Rust settings round-trip (read → write → read)"
    - "Frontend history_limit default matches backend default of 10000"
    - "Parakeet CPU fallback uses model ID 'small' that exists in the model registry"
  artifacts:
    - path: "src-tauri/src/shortcut.rs"
      provides: "Secure API key storage - no plaintext fallback when keyring succeeds"
      contains: "s.openrouter_api_key = None"
    - path: "src-tauri/src/settings.rs"
      provides: "theme_mode field in AppSettings struct"
      contains: "pub theme_mode: String"
    - path: "src/stores/settingsStore.ts"
      provides: "Correct frontend history_limit default"
      contains: "history_limit: 10000"
    - path: "src-tauri/src/lib.rs"
      provides: "Correct model ID fallback"
      contains: "\"small\""
  key_links:
    - from: "src-tauri/src/settings.rs"
      to: "src/lib/types.ts"
      via: "theme_mode field present in both Rust and TypeScript"
      pattern: "theme_mode"
---

<objective>
Fix settings model correctness and security issues from audit findings 1, 3, 9, and 13.

Purpose: Ensure API keys are stored securely, settings fields round-trip correctly between Rust and TypeScript, defaults are consistent, and model ID fallbacks match the registry.

Output: Four targeted fixes across settings-related files.
</objective>

<execution_context>
@C:/Users/hsbaz/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hsbaz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src-tauri/src/shortcut.rs
@src-tauri/src/settings.rs
@src/stores/settingsStore.ts
@src-tauri/src/lib.rs
@src-tauri/src/managers/model.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API key storage and theme_mode round-trip</name>
  <files>src-tauri/src/shortcut.rs, src-tauri/src/settings.rs</files>
  <action>
**Finding 1 — API key plaintext fallback (shortcut.rs:396-400):**

In `change_openrouter_api_key_setting`, inside the `if keyring_works` branch (line 396-400), change:
```rust
// CHANGED: Always keep fallback in settings file even if keyring works
// This ensures ghostwriting works even if keyring becomes unreliable later
s.openrouter_api_key = api_key.clone();
```
to:
```rust
// Keyring works — clear plaintext from settings file for security.
// get_openrouter_api_key_setting already handles keyring → settings fallback on read.
s.openrouter_api_key = None;
```

This is safe because `get_openrouter_api_key_setting` (line 364-384) already reads from keyring first, then falls back to settings file with auto-migration. The fallback read path handles the case where keyring becomes unreliable later.

**Finding 3 — theme_mode missing from Rust AppSettings (settings.rs):**

Add a `theme_mode` field to the `AppSettings` struct:
```rust
#[serde(default = "default_theme_mode")]
pub theme_mode: String,
```

Add the default function:
```rust
fn default_theme_mode() -> String {
    "system".to_string()
}
```

Add the field to `get_default_settings()` return value:
```rust
theme_mode: default_theme_mode(),
```

This ensures `theme_mode` set by the frontend is preserved when the backend writes settings back.
  </action>
  <verify>
Run `cargo check` from `src-tauri/` to verify compilation. Grep for `theme_mode` in settings.rs to confirm the field exists. Grep for `s.openrouter_api_key = None` in shortcut.rs inside the keyring_works branch.
  </verify>
  <done>
API key is cleared from plaintext settings when keyring succeeds. theme_mode field exists in Rust AppSettings and round-trips through serde correctly with "system" as default.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix frontend default and model ID fallback</name>
  <files>src/stores/settingsStore.ts, src-tauri/src/lib.rs</files>
  <action>
**Finding 9 — Frontend history_limit default mismatch (settingsStore.ts:55):**

In `src/stores/settingsStore.ts`, change:
```typescript
history_limit: 5,
```
to:
```typescript
history_limit: 10000,
```

This matches the backend default in `settings.rs:271` (`default_history_limit` returns 10000).

**Finding 13 — model_id mapping inconsistency (lib.rs:230):**

In `src-tauri/src/lib.rs`, find the Parakeet CPU fallback line (~line 230):
```rust
selected_model = "whisper-small".to_string();
```
Change to:
```rust
selected_model = "small".to_string();
```

Also update the related frontend notification JSON (around line 243) that references "whisper-small":
```rust
"fallback_model": "whisper-small"
```
Change to:
```rust
"fallback_model": "small"
```

The model registry in `managers/model.rs:72` uses ID `"small"`, not `"whisper-small"`. The fallback must use the registry ID so the model can actually be found and loaded.
  </action>
  <verify>
Grep settingsStore.ts for `history_limit: 10000`. Grep lib.rs for the fallback model string — should find `"small"` not `"whisper-small"`. Run `cargo check` from src-tauri/.
  </verify>
  <done>
Frontend history_limit default is 10000 matching backend. Parakeet CPU fallback uses model ID "small" that exists in the model registry.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` passes in src-tauri/ (Rust compilation)
2. `bun run build` passes (frontend TypeScript compilation)
3. No references to `"whisper-small"` remain in lib.rs fallback code
4. `theme_mode` field present in AppSettings struct with serde default
5. API key storage: inside `if keyring_works` branch, `s.openrouter_api_key` is set to `None`
</verification>

<success_criteria>
All four settings-related audit findings (1, 3, 9, 13) are resolved. Settings model is consistent between Rust and TypeScript. API key security is restored. Model fallback works correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/11-fix-all-audit-findings/11-01-SUMMARY.md`
</output>
